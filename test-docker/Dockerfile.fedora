FROM fedora:40

RUN dnf install -y \
    openssh-server \
    bash \
    coreutils \
    findutils \
    grep \
    hostname \
    procps-ng \
    net-tools \
    passwd \
    && dnf clean all

# Generate host keys
RUN ssh-keygen -A

# Create test users
RUN useradd -m -s /bin/bash testuser && echo "testpass" | passwd --stdin testuser
RUN useradd -m -s /bin/bash admin && echo "adminpass" | passwd --stdin admin

# Configure sshd: allow password auth
RUN sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config && \
    sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin no/' /etc/ssh/sshd_config

# Create test directories and files for testuser
RUN mkdir -p /home/testuser/projects/src && \
    echo 'console.log("hello world");' > /home/testuser/projects/src/app.ts && \
    echo '{"name":"test"}' > /home/testuser/projects/package.json && \
    echo 'TODO: fix bug' > /home/testuser/projects/src/todo.ts && \
    mkdir -p /home/testuser/logs && \
    echo '[2024-01-01] Server started' > /home/testuser/logs/app.log && \
    chown -R testuser:testuser /home/testuser

# Create test directories and files for admin
RUN mkdir -p /home/admin/configs && \
    echo 'server.port=8080' > /home/admin/configs/server.conf && \
    echo 'db.host=localhost' > /home/admin/configs/db.conf && \
    mkdir -p /home/admin/scripts && \
    printf '#!/bin/bash\necho "deploy complete"' > /home/admin/scripts/deploy.sh && \
    chmod +x /home/admin/scripts/deploy.sh && \
    chown -R admin:admin /home/admin

EXPOSE 22

CMD ["/usr/sbin/sshd", "-D", "-e"]

FROM alpine:3.19

RUN apk add --no-cache \
    openssh-server \
    bash \
    coreutils \
    findutils \
    grep \
    procps \
    net-tools

# Generate host keys
RUN ssh-keygen -A

# Create test users: testuser (password + key), admin (password), keyuser (key-only)
RUN adduser -D -s /bin/bash testuser && echo "testuser:testpass" | chpasswd
RUN adduser -D -s /bin/bash admin && echo "admin:adminpass" | chpasswd
RUN adduser -D -s /bin/bash keyuser && passwd -u keyuser

# Configure sshd: enable password + pubkey auth
RUN sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config && \
    sed -i 's/#PubkeyAuthentication yes/PubkeyAuthentication yes/' /etc/ssh/sshd_config && \
    sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin no/' /etc/ssh/sshd_config && \
    sed -i 's/#UsePAM yes/UsePAM no/' /etc/ssh/sshd_config && \
    echo 'Subsystem sftp /usr/lib/ssh/sftp-server' >> /etc/ssh/sshd_config

# Create test directories and files for testuser
RUN mkdir -p /home/testuser/projects/src && \
    echo 'console.log("hello world");' > /home/testuser/projects/src/app.ts && \
    echo '{"name":"test"}' > /home/testuser/projects/package.json && \
    echo 'TODO: fix bug' > /home/testuser/projects/src/todo.ts && \
    mkdir -p /home/testuser/logs && \
    echo '[2024-01-01] Server started' > /home/testuser/logs/app.log && \
    chown -R testuser:testuser /home/testuser

# Create test directories and files for admin
RUN mkdir -p /home/admin/configs && \
    echo 'server.port=8080' > /home/admin/configs/server.conf && \
    echo 'db.host=localhost' > /home/admin/configs/db.conf && \
    mkdir -p /home/admin/scripts && \
    printf '#!/bin/bash\necho "deploy complete"' > /home/admin/scripts/deploy.sh && \
    chmod +x /home/admin/scripts/deploy.sh && \
    chown -R admin:admin /home/admin

# Create home for keyuser
RUN mkdir -p /home/keyuser && chown -R keyuser:keyuser /home/keyuser

COPY entrypoint-keys.sh /entrypoint.sh
RUN sed -i 's/\r$//' /entrypoint.sh && chmod +x /entrypoint.sh

EXPOSE 22

ENTRYPOINT ["/entrypoint.sh"]

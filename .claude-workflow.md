<!--
Copyright 2026 SSH Lite Contributors

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->

# SSH Lite - Claude Code Workflow

This file documents how to regenerate the SSH Lite VS Code extension using Claude Code.

---

## IMPORTANT: Claude Code Rules

**YOU MUST FOLLOW THESE RULES AT EVERY PROMPT:**

1. **READ this workflow file at the START of every prompt** - Before doing anything else
2. **UPDATE this workflow file** if there are any flow/feature/implementation changes
3. **ALWAYS sync between workflow file and source code** - After every code change, update this file to reflect the current state. After every workflow file change, ensure source code matches.
4. **NEVER forget these rules** - They are critical for maintaining project consistency
5. **DEBATE the user** if they request a feature that violates:
   - **LITE principles** (uses server resources automatically, polls, preloads without user action)
   - **Simplicity principles** (overly complex, too many options, confusing UX)
   - Push back respectfully and propose LITE/simple alternatives before implementing

---

## Project Overview

**SSH Lite** is a lightweight VS Code extension for SSH connections that works WITHOUT installing a VS Code server on remote machines (unlike Remote-SSH).

### Core Principles
1. **Simple and easy to use** - This is the MOST important principle
2. **No server installation** - Works via pure SSH/SFTP
3. **Auto-save credentials** - No complex credential management
4. **Lightweight** - Minimal footprint

---

## ‚ö†Ô∏è LITE PRINCIPLES (CRITICAL - READ BEFORE IMPLEMENTING)

**SSH Lite must be LITE.** The LITE principle has two meanings:

### 1. LITE Server Resources
Minimize server resource usage and SSH connections at all costs.

### 2. LITE UI/UX
- Easy to use, not complex
- Easy to understand at first use
- Minimal UI intrusion
- Non-blocking feedback
- Clear, intuitive actions

### Rules for ALL Features:

1. **NO automatic server commands** - Never run shell commands (grep, find, ls, etc.) automatically
   - ‚ùå BAD: Running `find` on every filter keystroke
   - ‚úÖ GOOD: User clicks "Search" button to trigger server search

2. **NO polling/background refresh by default** - All auto-refresh features must be:
   - Disabled by default (interval = 0)
   - User must explicitly enable in settings
   - Use reasonable minimum intervals (>10s)

3. **Cache aggressively, fetch lazily** - Prefer local cache over server requests
   - ‚ùå BAD: Preloading 5 subdirectories automatically
   - ‚úÖ GOOD: Load only what user explicitly expands

4. **Single connection per host** - Reuse SSH connections, never open multiple
   - Terminal, SFTP, and commands share the same connection

5. **Debounce user actions** - Rapid user input should not spam the server
   - Minimum 300ms debounce for any server-triggering action

6. **Opt-in expensive features** - Features that use server resources should:
   - Require explicit user action (button click, command)
   - Show clear indication of server activity
   - Be configurable to disable

### When Reviewing New Features, Ask:

1. Does this run server commands automatically? ‚Üí Make it user-triggered
2. Does this poll the server? ‚Üí Make it opt-in with default OFF
3. Does this preload data? ‚Üí Make it lazy-load on demand
4. Does this open new connections? ‚Üí Reuse existing connection

### Current Violations (FIXED):

- [x] Deep filter search runs `find` automatically ‚Üí Fixed: Now user-triggered via "Search Server for Filter" button
- [x] Subdirectory preloading ‚Üí Fixed: Disabled by default, controlled by `sshLite.enablePreloading` setting
- [x] Frequent file preloading ‚Üí Fixed: Disabled by default, controlled by `sshLite.enablePreloading` setting

---

## üßπ CODE QUALITY GUIDELINES

### Keep Source Clean
1. **Remove unused files/folders** - Delete files that are no longer imported or used
2. **Remove dead code** - Delete commented-out code, unused functions, unused imports
3. **Consolidate duplicates** - If similar logic exists in multiple places, refactor to share

### Logging Best Practices
Use the `log()` function to write to the output channel. Follow these rules:

1. **Log useful context** - Include enough info to trace errors
   ```typescript
   log(`Connecting to ${host.name} (${host.host}:${host.port})...`);
   ```

2. **Log errors with context** - Always include what operation failed
   ```typescript
   log(`Failed to list files in ${remotePath}: ${error.message}`);
   ```

3. **Avoid logging in loops** - Don't spam logs during iteration
   ```typescript
   // ‚ùå BAD: Logs every file
   for (const file of files) {
     log(`Processing ${file.name}`);
   }

   // ‚úÖ GOOD: Log summary
   log(`Processing ${files.length} files in ${remotePath}`);
   ```

4. **Log state changes** - Connection, disconnection, file operations
   ```typescript
   log(`Connected to ${host.name}`);
   log(`File saved: ${remotePath}`);
   ```

5. **Point to error logs** - When showing user error, also log details
   ```typescript
   log(`Upload failed: ${error.message}\nStack: ${error.stack}`);
   vscode.window.showErrorMessage(`Upload failed: ${error.message}`);
   ```

6. **Use log levels conceptually**:
   - Important operations: Always log
   - Debug info: Comment out or remove before commit
   - Errors: Always log with stack trace

---

## Features to Implement

### 1. SSH Connection Management
- Parse `~/.ssh/config` for hosts
- Allow manual host addition (saved to VS Code settings)
- Support password, private key, and SSH agent authentication
- Auto-save credentials using VS Code SecretStorage
- Keyboard-interactive authentication support
- Connection timeout (configurable, default 30s)
- Keepalive interval (configurable)

### 2. File Browser (Tree View)
- Show connected servers in sidebar
- Browse remote files/folders via SFTP
- Navigate to any path (Go to Path, Go to Parent, Go to Home, Go to Root)
- Show current path in connection description
- Parent folder (..) navigation
- Auto-refresh tree (configurable interval)

### 3. File Operations
- Open remote files for editing
- Auto-upload on save
- Download files/folders
- Upload files
- Delete files/folders
- Create folders
- Large file handling (>100MB):
  - Background download with progress
  - Preview first lines
  - Download to disk
  - View with head/tail

### 4. File Auto-Refresh
- Global timer for all opened files
- Prioritize focused file (refresh first)
- Refresh non-focused files after focused
- Smart conflict handling:
  - Auto-refresh if no local changes
  - Prompt if local unsaved changes exist

### 5. Terminal
- Open SSH terminal for any connection
- Multiple terminals per connection
- Reuse existing connection (no re-login)

### 6. Port Forwarding
- Forward local ports to remote
- List active forwards
- Stop forwards

### 7. Server Monitoring
- Quick status (CPU, memory, disk, load)
- Diagnose slowness (top processes, memory hogs)
- Watch status (live updates)
- Check specific service
- List services
- Recent logs
- Network diagnostics

### 8. Audit Trail
- Log all file operations (download, upload, edit, delete)
- Track diffs for edits
- Export audit log
- Clear audit log

### 9. Search (VS Code-style Panel)
- Webview-based search panel
- Horizontal layout: controls on left, results on right
- Resizable controls section (drag vertical divider)
- Multiple search scopes (folders or files from different connections)
- Include/exclude file patterns (collapsible)
- Case-sensitive and regex options
- Results grouped by file with line numbers
- Results sorted alphabetically by path, then by line number
- **Server grouping**: Multi-server results MUST show server name header rows to separate results by server
- Toggle between list view (‚ò∞) and tree view (üå≤)
- Tree view shows hierarchical directory structure
- Auto-expand to file level on first switch to tree view (matches stay collapsed)
- Click to open file at specific line
- Reveal in Tree button (üìç) to navigate to file in explorer
- **Cancel on new search**: Firing a new search MUST cancel any currently running search
- Unlimited search results (set maxResults to 0)

### 10. Filename Filter
- Filter files in tree by glob pattern
- Highlighted matches in tree view (yellow icons for matching files/parent dirs)
- Local filename matching fallback when server-side `find` paths don't match tree paths
- Filtered folder shows blue `filter-filled` icon with `[filter: pattern]` description
- Inline "clear filter" (X) button on filtered folder (`contextValue: folder.filtered`)
- Context menu "Clear Filename Filter" on filtered folder
- Navigation bar clear button when any filter is active
- Server-side search option for deep filtering
- Clear filter to reset

### 11. Auto-Reconnect
- Automatic reconnection on VPN/network drop
- Preserves credential for seamless reconnect
- Shows reconnecting status in tree
- Manual disconnect does NOT trigger auto-reconnect

### 12. Activity Panel
- View all running operations (search, download, upload, etc.)
- Group by server or by type
- Cancel individual or all activities
- Auto-remove completed/failed after timeout

### 13. Orphaned File Handling
- Detect SSH files from previous session
- Show "Reconnect to Server" button
- Restore file mapping after reconnection

### 14. Progressive Downloads
- Large files show tail preview immediately
- Full content loads in background
- Progress tracking for downloads

### 15. Real-Time File Watching
- inotifywait on Linux for instant updates
- fswatch on macOS
- Polling fallback if native tools unavailable
- Eye icon shows for watched files

### 16. Change Tracking
- "M" badge on modified files (FileDecorationProvider) using git-style yellow color
- Inline diff icon `$(diff)` only on modified files (one-click to see changes)
- "Show Changes" context menu on modified files
- Uses server backup at `/tmp/.ssh-lite-backups` (no working directory changes)
- Cross-session persistence via `.ssh-lite-index` file mapping backup ‚Üí original paths
- Connection scan at LOW priority restores modification state from previous sessions
- Configurable on/off with `enableChangeTracking` (default: true)
- Exception patterns with `changeTrackingExceptions` (glob)
- Modified state cleared on disconnect or revert

## Project Structure

```
SSHLite/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ extension.ts              # Main entry, command registration
‚îÇ   ‚îú‚îÄ‚îÄ types.ts                  # Interfaces and types
‚îÇ   ‚îú‚îÄ‚îÄ connection/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ConnectionManager.ts  # Manage multiple connections, auto-reconnect
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ SSHConnection.ts      # SSH/SFTP operations, file watching
‚îÇ   ‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ HostService.ts        # Parse SSH config, manage hosts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ FileService.ts        # File operations, auto-sync, backups
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ TerminalService.ts    # SSH terminals
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ PortForwardService.ts # Port forwarding
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ CredentialService.ts  # Credential storage with pinned folders
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AuditService.ts       # Audit trail logging
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ServerMonitorService.ts # Server diagnostics, live monitor panel
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ PriorityQueueService.ts # Priority-based task queue for preloading
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ FolderHistoryService.ts # Track folder/file access history
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ProgressiveDownloadManager.ts # Large file progressive downloads
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ActivityService.ts    # Track running operations for Activity panel
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ CommandGuard.ts       # Man-in-the-middle guard for command/data tracking
‚îÇ   ‚îú‚îÄ‚îÄ providers/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ HostTreeProvider.ts   # SSH hosts tree view with credentials
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ FileTreeProvider.ts   # Remote files tree view with filter/highlight
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ FileDecorationProvider.ts # "M" badge on modified files
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ PortForwardTreeProvider.ts # Port forwards tree
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ActivityTreeProvider.ts # Activity panel tree view
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ProgressiveFileContentProvider.ts # Virtual documents for previews
‚îÇ   ‚îú‚îÄ‚îÄ webviews/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ SearchPanel.ts        # VS Code-style search webview panel
‚îÇ   ‚îú‚îÄ‚îÄ types/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ progressive.ts        # Progressive download types
‚îÇ   ‚îî‚îÄ‚îÄ utils/
‚îÇ       ‚îî‚îÄ‚îÄ helpers.ts            # Utility functions
‚îú‚îÄ‚îÄ package.json                  # Extension manifest
‚îú‚îÄ‚îÄ tsconfig.json                 # TypeScript config
‚îú‚îÄ‚îÄ .vscodeignore                 # Exclude from package
‚îú‚îÄ‚îÄ .vscode/
‚îÇ   ‚îú‚îÄ‚îÄ launch.json               # F5 debugging
‚îÇ   ‚îî‚îÄ‚îÄ tasks.json                # Build tasks
‚îî‚îÄ‚îÄ README.md                     # Documentation with SEO
```

## Key Implementation Details

### CredentialService (Multiple Credentials per Host)
```typescript
// Support multiple named credentials per host with pinned folders
interface PinnedFolder {
  id: string;
  name: string;
  remotePath: string;
}

interface SavedCredential {
  id: string;
  label: string;
  type: 'password' | 'privateKey';
  privateKeyPath?: string;
  pinnedFolders?: PinnedFolder[];
}

// API
await creds.listCredentials(hostId)  // List all credentials for a host
await creds.addCredential(hostId, label, type, value, keyPath?)
await creds.getCredentialSecret(hostId, credentialId)
await creds.deleteCredential(hostId, credentialId)
await creds.deleteAll(hostId)

// Pinned folders API
await creds.addPinnedFolder(hostId, credentialId, name, remotePath)
await creds.deletePinnedFolder(hostId, credentialId, folderId)
await creds.renamePinnedFolder(hostId, credentialId, folderId, newName)
await creds.getPinnedFolders(hostId, credentialId)

// Legacy API for backward compatibility
await creds.get(hostId, 'password')
await creds.save(hostId, 'password', value)
await creds.getOrPrompt(hostId, 'password', 'Enter password')
```

### HostTreeProvider (Expandable Hosts)
- Hosts are expandable (collapsed by default) to show credentials
- Connected hosts are NOT expandable (already connected)
- Child items: CredentialTreeItem (click to connect), AddCredentialTreeItem (+ to add)
- Click on credential to connect with that specific credential
- Credentials with pinned folders are expandable to show PinnedFolderTreeItem children
- Click on pinned folder to connect and navigate to that folder

### SSHConnection Authentication Flow
- If specific credential provided: use only that credential
- Otherwise (legacy): Try multiple auth methods
  1. Try configured private key
  2. Try default keys (~/.ssh/id_rsa, id_ed25519, id_ecdsa)
  3. Try SSH agent
  4. Fall back to password (always included for keyboard-interactive)
  5. Handle keyboard-interactive auth
  6. On auth failure, clear saved credentials

### FileService Auto-Refresh
```typescript
// Single global timer, not per-file
private globalRefreshTimer
private isRefreshing = false

async refreshOpenedFiles() {
  // 1. Refresh focused file first
  // 2. Then refresh other non-focused files
}
```

### CommandGuard (Activity Tracking)
The CommandGuard provides a "man in the middle" pattern for tracking all data transfer between local and server.

```typescript
// CommandGuard - centralized activity tracking
class CommandGuard {
  // Track file operations
  async readFile(connection, remotePath, options?): Promise<Buffer>
  async writeFile(connection, remotePath, content, options?): Promise<void>
  async listFiles(connection, remotePath, options?): Promise<IRemoteFile[]>

  // Track monitored files
  startMonitoring(connection, remotePath): string // returns activityId
  stopMonitoring(activityId): void

  // Track connections
  startConnect(hostName, connectionId): string
  completeConnect(activityId): void
  failConnect(activityId, error): void
}
```

**Activity Types:**
- `download` - File downloads/opens
- `upload` - File uploads/saves
- `directory-load` - Directory listing
- `monitor` - File watching (persistent)
- `search` - Content/filename searches
- `connect`/`disconnect` - Connection state
- `file-refresh` - File content refresh

**LITE Compliance:**
- Only track user-visible operations
- Don't track preloads or background metadata
- Monitor activities are persistent (don't auto-remove)
- Completed activities auto-remove after 3s

### FileTreeProvider Navigation
- Track current path per connection: `Map<connectionId, path>`
- Show (..) parent folder item at top
- Commands: goToPath, goToParent, goToHome, goToRoot

## Configuration Options

```json
{
  "sshLite.connectionTimeout": 30000,
  "sshLite.keepaliveInterval": 30000,
  "sshLite.defaultRemotePath": "~",
  "sshLite.autoUploadOnSave": true,
  "sshLite.uploadDebounceMs": 500,
  "sshLite.treeRefreshIntervalSeconds": 10,
  "sshLite.fileRefreshIntervalSeconds": 3,
  "sshLite.smartRefreshThreshold": 512000,
  "sshLite.largeFileSizeThreshold": 104857600,
  "sshLite.auditLogPath": "",
  "sshLite.tempFileRetentionHours": 504,
  "sshLite.credentialIndex": {},
  "sshLite.searchMaxResults": 2000,
  "sshLite.filterMaxResults": 1000,
  "sshLite.enableChangeTracking": true,
  "sshLite.changeTrackingExceptions": []
}
```

**Note:** Set `searchMaxResults` or `filterMaxResults` to 0 for unlimited results.

## Dependencies

```json
{
  "dependencies": {
    "ssh2": "^1.16.0",
    "ssh-config": "^5.0.0"
  }
}
```

## Commands to Register

### Connection & Hosts
- sshLite.connect
- sshLite.disconnect
- sshLite.addHost
- sshLite.editHost
- sshLite.removeHost
- sshLite.refreshHosts
- sshLite.reconnectOrphanedFile

### Navigation
- sshLite.goToPath
- sshLite.goToParent
- sshLite.goToHome
- sshLite.goToRoot

### File Operations
- sshLite.openFile
- sshLite.downloadFile
- sshLite.uploadFile
- sshLite.deleteRemote
- sshLite.createFolder
- sshLite.refreshFiles
- sshLite.refreshItem
- sshLite.copyPath
- sshLite.revealInTree

### Terminal & Port Forwarding
- sshLite.openTerminal
- sshLite.openTerminalHere
- sshLite.forwardPort
- sshLite.stopForward

### Audit & Monitoring
- sshLite.showAuditLog
- sshLite.exportAuditLog
- sshLite.clearAuditLog
- sshLite.monitor
- sshLite.quickStatus
- sshLite.diagnoseSlowness

### Credentials
- sshLite.clearCredentials
- sshLite.addCredential
- sshLite.connectWithCredential
- sshLite.deleteCredential
- sshLite.savePassword
- sshLite.copyHost

### Temp Files & Cache
- sshLite.clearAllTempFiles
- sshLite.clearTempFilesForConnection
- sshLite.openTempFolder
- sshLite.clearCache

### Pinned Folders
- sshLite.pinFolder
- sshLite.connectToPinnedFolder
- sshLite.deletePinnedFolder
- sshLite.renamePinnedFolder

### Backups & Changes
- sshLite.revertFile
- sshLite.showFileBackups
- sshLite.showServerBackups
- sshLite.showChanges
- sshLite.clearServerBackups
- sshLite.showBackupLogs
- sshLite.openServerBackupFolder
- sshLite.showAllBackups

### Filter & Search
- sshLite.filterFiles
- sshLite.clearFilter
- sshLite.searchServerForFilter
- sshLite.showSearch
- sshLite.searchInScope
- sshLite.filterFileNames
- sshLite.clearFilenameFilter
- sshLite.searchInFile
- sshLite.cancelSearch
- sshLite.revealSearchResultInTree

### Preloading
- sshLite.cancelPreloading

### Activity Panel
- sshLite.cancelActivity
- sshLite.cancelAllActivities
- sshLite.cancelServerActivities
- sshLite.clearActivities
- sshLite.toggleActivityGrouping

## Regeneration Steps

1. Create new VS Code extension project:
   ```bash
   npm init -y
   npm install ssh2 ssh-config
   npm install -D typescript @types/node @types/vscode @types/ssh2
   ```

2. Copy the project structure above

3. Ask Claude Code to implement each service following the patterns described

4. Key reminders for Claude:
   - Keep CredentialService SIMPLE (no profiles, auto-save by default)
   - File refresh: focused file first, then others
   - Navigation: track current path per connection
   - Always handle keyboard-interactive auth

## Testing

Press F5 in VS Code to launch extension development host.

### Automated Tests
- **Integration tests**: Write integration tests for important features (file operations, search, connection management)
- **E2E tests**: Write end-to-end tests for critical user flows (open file ‚Üí edit ‚Üí save ‚Üí reopen, search across servers, filter files)
- Test framework: Jest (`npm test`)
- Tests should cover: file save/upload flow, debounce behavior, search cancellation, multi-server search grouping, filter highlighting

## Building

```bash
npm run compile    # Compile TypeScript
npm run watch      # Watch mode
npm run clean      # Clean build artifacts
```

## Packaging

```bash
npx vsce package   # Creates .vsix file
```

---

## Known Bugs / TODO

Track open issues and pending work here:

1. **Write integration & e2e tests**: Important features lack automated test coverage (see Testing section)

---

## Recent Changes Log

Track all significant changes here:

### 2026-01-26
- **Search: auto-cancel on new search**: New search automatically kills the previous running search (server-side process terminated via SSH channel close)
  - Added `signal?: AbortSignal` parameter to `SSHConnection.searchFiles()`
  - Stream is closed (killing remote grep/find process) when abort signal fires
  - `SearchPanel.performSearch()` passes its AbortSignal through to `searchFiles()`
  - Files: `src/connection/SSHConnection.ts`, `src/webviews/SearchPanel.ts`
- **Search: multi-server grouping fix**: Server grouping rows now always appear when searching across multiple servers
  - `multiServer` flag now based on `scopeServers` (search scopes) instead of result servers ‚Äî ensures grouping even when one server returns zero results
  - `scopeServers` array sent from `performSearch()` to webview alongside results
  - Both list view and tree view pre-populate server groups from `scopeServers`, showing "No results" for servers without matches
  - Server summary in header shows per-server counts for all scope servers
  - Files: `src/webviews/SearchPanel.ts`
- **Fix: skipNextSave leak silently eating user saves**: Removed 5 `skipNextSave.add()` calls before `workbench.action.files.revert` commands
  - **Root cause**: `revert` does NOT trigger `onDidSaveTextDocument`, so `skipNextSave` was never consumed and silently skipped the next real user save
  - **Affected methods**: Backup restore (line 1094), notification restore (line 1470), `refreshSingleFile` (line 2249), `refreshOpenFile` (line 2345, 2392)
  - **Correct usages retained**: Lines 2582, 2740 ‚Äî these use `document.save()` which DOES fire `onDidSaveTextDocument`
  - Files: `src/services/FileService.ts`
- **Fix: Saved files reverting on reopen**: Fixed race condition where saved remote files reverted to old content when closed and reopened
  - **Root cause 1**: `document.getText()` was called inside 500ms debounce setTimeout callback ‚Äî if user closed tab before timer fired, the TextDocument was disposed and content was stale/empty
  - **Root cause 2**: Race condition on close+reopen ‚Äî reopening triggered re-download from server before the debounced upload completed
  - **Fix**: (1) Capture `document.getText()` eagerly at save time, not inside debounce callback. (2) Flush pending uploads on `onDidCloseTextDocument`. (3) Await pending uploads in `openRemoteFile` before re-downloading.
  - Added `pendingUploads` and `pendingUploadPromises` tracking maps, `flushPendingUpload()` method
  - Files: `src/services/FileService.ts`
- **Filename Filter improvements**: Fixed filter not working, added visual feedback
  - Blue `filter-filled` icon on filtered folders with `[filter: pattern]` description
  - Local filename matching fallback (`shouldHighlightByFilter()`) when server-side `find` paths don't match tree paths
  - Inline "clear filter" (X) button on filtered folders (`contextValue: folder.filtered`)
  - Updated `viewItem` patterns from `== folder` to `=~ /^folder/` for menu compatibility
  - Files: `src/providers/FileTreeProvider.ts`, `src/extension.ts`, `package.json`
- **Change Tracking (Feature #16)**: Git-like "Show Changes" for remote files
  - "M" badge (yellow) on modified files using `FileDecorationProvider` with `gitDecoration.modifiedResourceForeground`
  - Inline diff icon `$(diff)` appears only on modified files (`contextValue: 'file.modified'`)
  - "Show Changes" command shows diff between server backup (original) and current file
  - Cross-session persistence via `.ssh-lite-index` file in `/tmp/.ssh-lite-backups`
  - Connection scan at LOW priority restores modification state from previous sessions
  - Configurable: `sshLite.enableChangeTracking` (bool, default true), `sshLite.changeTrackingExceptions` (glob array)
  - Exception logic: ON+exception=excluded, OFF+exception=included
  - Modified state cleared on disconnect (`cleanupConnection`) or revert (`restoreFromServerBackup`)
  - Custom glob matcher (`matchGlob`) supports `*`, `**`, `?` patterns without external dependency
  - Files: `src/providers/FileDecorationProvider.ts` (NEW), `src/services/FileService.ts`, `src/providers/FileTreeProvider.ts`, `src/extension.ts`, `package.json`

### 2026-01-23
- **CommandGuard pattern**: Created centralized "man in the middle" service for tracking all data transfer
  - `CommandGuard.ts` provides wrapped methods for readFile, writeFile, listFiles, etc.
  - All tracked operations automatically appear in Activity panel
- **Activity tracking integrated**:
  - File open/download operations tracked with progress
  - Directory loading tracked when user expands folders
  - File monitoring (watch) shows persistent activity while file is being watched
  - Connection loss during watch shows as failed activity
  - Connect/disconnect operations tracked in ConnectionManager
  - Auto-save uploads tracked via CommandGuard.writeFile
- **LITE compliance**: Only user-visible operations tracked, not preloads or background metadata
- **Search improvements**:
  - **Unlimited search**: Set `sshLite.searchMaxResults` to 0 for unlimited results (removed upper limit)
  - **Sorted results**: Search results now sorted alphabetically by path, then by line number within each file
  - **Tree view**: Toggle between list view (‚ò∞) and tree view (üå≤) in results header
    - Tree view shows hierarchical directory structure with collapsible folders
    - Folders show match counts, files expandable to show matches
    - Directories sorted first, then files alphabetically
- **Bug fixes**:
  - **Fixed auto-reconnect after manual disconnect**: SSH2 'close' event fires asynchronously after disconnect() returns. Previous code deleted the `isManualDisconnect` flag before the event fired, causing auto-reconnect to trigger. Fixed by keeping the flag until state handler cleans up.
  - **Fixed tree state reset on disconnect**: Multiple rapid connection change events during disconnect confused VS Code's tree expansion state tracking. Added 50ms debounce to consolidate events into single refresh.
  - **Fixed reveal in tree command**: Implemented missing `sshLite.revealSearchResultInTree` command
  - **Fixed terminal null check**: Added null check in searchInFile before using terminal
  - **Fixed search for text with dashes (e.g., "-lfsms-")**: Added `--` to grep command to signal end of options, allowing patterns starting with dash
- **Raw command logging**: Full SSH/SFTP commands now visible in "SSH Lite Commands" output window
  - Removed 200 char truncation - shows complete grep/find commands with all parameters
  - Added SFTP operation logging (LIST, READ, WRITE) with paths and sizes
- **Resizable search panel**: Controls area (search input, patterns, scopes) can be vertically resized
  - Drag the horizontal divider between controls and results to resize
  - Min 100px, max 80% viewport height
- **Improved Activity panel coverage**: Added tracking for filter operations
  - Deep filter search (searchServerForFilter) now shows in Activity panel
  - Filename filter (setFilenameFilter) now shows in Activity panel
- **UX consistency improvements**:
  - Standardized message patterns: 2000ms (quick feedback), 3000ms (success), 5000ms (info/error)
  - Changed modal dialogs to status bar messages for non-critical actions (LITE principle)
  - Navigation feedback: goToParent, goToHome, goToRoot now show status bar confirmation
  - Backup operations use status bar instead of modal dialogs

### 2026-01-19
- Added config change listener to FileService - timer restarts when `fileRefreshIntervalSeconds` changes
- File refresh: focused file gets priority, non-focused files refresh after
- Added navigation commands: goToPath, goToParent, goToHome, goToRoot
- Added (..) parent folder item in file tree
- Track current path per connection in FileTreeProvider
- Fixed authentication to always include password for keyboard-interactive fallback
- Connection timeout increased to 30s default
- Clear saved credentials on auth failure
- **Optimized file opening**: Editor opens immediately with "Loading..." placeholder, content loads in background
- **Fixed: Clicking connected server no longer disconnects** - Click only connects disconnected hosts; disconnect via menu/icon
- **Credential management redesign**: Hosts now expandable to show saved credentials
  - Click on host expands to show credentials + "Add Credential..." item
  - Click on credential to connect with that specific auth method
  - Support for password and private key credentials with labels
  - Delete individual credentials via context menu
- **Temp file auto-cleanup**: Configurable `tempFileRetentionHours` (default 504h = 21 days)
  - Auto-cleanup runs hourly
  - Commands: clearAllTempFiles, clearTempFilesForConnection, openTempFolder
  - Open temp folder in file explorer via menu or command palette
- **Pinned folders**: Save frequently used folders to credentials for quick access
  - Right-click folder in file tree ‚Üí "Pin Folder to Credential"
  - Pinned folders appear under credentials in host tree
  - Click pinned folder to connect and navigate directly to that path
  - Right-click pinned folder to rename or delete
- **Connected hosts now expandable**: Can view credentials and pinned folders even when connected
  - Credentials show "(connected)" tooltip when host is connected
  - Pinned folders navigate directly when host is already connected
- **Loading indicators**: Show spinning icons during folder/file refresh
  - Connection shows loading spinner while listing directory
  - Status bar shows refresh indicator for focused file
- **Safe file loading**: File content loading doesn't trigger upload
  - Uses `skipNextSave` set to prevent upload when clearing dirty state after load
  - Double safety: mapping only added after save completes
- **Fixed file save conflict**: Auto-refresh now updates editor before disk
  - Updates editor content first, then saves (avoids VS Code conflict detection)
  - Uses `skipNextSave` to prevent upload when syncing FROM remote
- **Parallel loading and preloading**: Directory tree loads faster
  - Directory cache (30s TTL) avoids redundant API calls
  - Deduplication prevents multiple concurrent loads for same path
  - Preloads subdirectories in background (first 5 dirs)
  - Preloads all connection root directories in parallel
  - Cache-hit loads show instantly without loading indicator
- **File upload confirmation and backup system**: Safer file editing
  - Optional confirmation dialog before upload (`sshLite.confirmUpload` setting)
  - "View Changes" option shows diff before upload
  - Automatic backup of old content before each upload
  - Backup history stored in memory (max 10 per file) and on disk
  - "Revert" button in upload notification
  - `sshLite.revertFile` and `sshLite.showFileBackups` commands
  - Right-click file ‚Üí "Show File Backup History"
- **Server-side backup system**: Original files preserved on remote server
  - Creates backup in `/tmp/.ssh-lite-backups/` when opening file for edit
  - Backup filename includes timestamp: `filename_2026-01-19T12-30-45-123Z.ext`
  - `sshLite.showServerBackups` - View and restore from server backups
  - `sshLite.clearServerBackups` - Clear all backups for a connection
  - Show diff between current file and server backup
  - Restore creates backup of current version first (safety)
  - Auto-cleanup based on `tempFileRetentionHours` setting
- **Combined backup logs**: View all backups (local + server) in one place
  - `sshLite.showBackupLogs` - Right-click file to see combined backup history
  - Shows both local (memory/disk) and server-side backups sorted by date
  - View diff or restore from any backup
- **Open Server Backup Folder**: Quick access to remote backup directory
  - `sshLite.openServerBackupFolder` - Right-click connected host
  - Lists all backups in output panel
  - Option to open terminal at backup folder or clear all backups
- **Open Terminal Here**: Open terminal at file/folder location
  - `sshLite.openTerminalHere` - Right-click on file or folder in file tree
  - Opens SSH terminal and navigates to that directory
  - For files, navigates to parent directory
- **Smart preloading (opt-in)**: Preload folders and files for instant navigation
  - **LITE**: Disabled by default (`sshLite.enablePreloading: false`)
  - When enabled: preloads home, parent, frequent folders/files
  - File history tracked in `FolderHistoryService` alongside folder history
- **Fixed double slash in paths**: Terminal "Open Here" no longer shows `//path`
  - Fixed `mapFileList` in `SSHConnection.ts` to handle root path specially
- **Fixed file preview mode**: Double-click files now open in edit mode (non-italic tab)
  - Added `{ preview: false }` to all `showTextDocument` calls
- **Fixed tree indentation on scroll**: Files no longer appear at wrong indent level
  - `getParent` method now properly returns parent `FileTreeItem` for nested directories
  - VS Code's tree virtualization can correctly reconstruct hierarchy when scrolling
- **File filter (LITE mode)**: Filter files in tree view
  - `sshLite.filterFiles` - Open filter input (supports glob: *.ts, config*, etc.)
  - `sshLite.clearFilter` - Clear the current filter
  - `sshLite.searchServerForFilter` - **User-triggered** server search for current filter
  - Filter icon in file explorer title bar
  - **LITE**: Only filters cached/loaded files by default (no server commands)
  - **Optional**: Click "Search Server" button to run `find` on server
  - Directories always shown when filtering (to allow navigation)
  - Supports `*` (any chars) and `?` (single char) wildcards
  - Server search results limited to 200 files per connection
- **Remote file search**: Search files on remote server using grep/find
  - `sshLite.searchInFolder` - Search in a specific folder (right-click folder or title bar icon)
  - `sshLite.openSearchResult` - Open file at search result location
  - `sshLite.clearSearchResults` - Clear search results panel
  - Content search uses `grep -rnH` for recursive text search with line numbers
  - Filename search uses `find` command for matching file paths
  - Case-insensitive by default, configurable via search options
  - File pattern filter (e.g., *.ts, *.py) to limit search scope
  - Max results limit (default 500) to prevent overwhelming output
  - Results grouped by file in tree view with expandable matches
  - Click result to open file at exact line number
- **Session-based directory caching**: Cache persists until disconnect for faster navigation
  - Removed 30-second TTL from directory cache - cache now persists for entire session
  - Cache cleared automatically on disconnect (manual or unexpected)
  - Deep filter results also cleared on disconnect
  - Preloading continues to load first 5 subdirectories on folder expand
- **Loading spinner on tree items**: Shows spinning icon when loading folder contents
  - `LoadingTreeItem` class shows `$(sync~spin)` spinning icon
  - Appears as child of folder/connection being expanded while loading
  - Replaced await-based loading with non-blocking pattern for immediate visual feedback
  - Tree item refreshes automatically when loading completes

### 2026-01-20
- **Smart tail-based file refresh**: Reduces bandwidth for large growing files
  - Files above threshold (default 500KB) that grow use incremental tail fetch
  - Only new bytes are downloaded instead of entire file (97%+ bandwidth reduction)
  - Falls back to full download if file shrinks or tail command fails
  - Shows status: `$(zap) Smart refresh: file.log (+10KB, saved 5MB)`
  - `sshLite.smartRefreshThreshold` setting (default: 512000 = 500KB, set 0 to disable)
  - **LITE compliant**: Reduces server load of existing refresh feature
  - New `readFileTail()` method in SSHConnection uses `tail -c +OFFSET`
  - `FileMapping` interface extended with `lastRemoteSize` for tracking
- **Real-time file watching with inotify/fswatch**: Instant file updates like Microsoft Remote-SSH
  - Automatically watches the focused/active SSH file for changes
  - Uses `inotifywait` on Linux (instant kernel notifications)
  - Uses `fswatch` on macOS/BSD (instant file system events)
  - Falls back to polling if native tools not available
  - `ServerCapabilities` interface tracks OS and available watchers
  - `detectCapabilities()` runs on connection to detect OS and tools
  - `watchFile()`/`unwatchFile()` methods for managing watchers
  - `onFileChange` event emitter for change notifications
  - 100ms debounce for rapid changes (log files)
  - Shows status: `$(eye) Watching file.log for changes`
  - **LITE compliant**: Only watches focused file, stops when switching files
- **File/folder timestamps in tree view**: Shows last modified time for better file management
  - Modified time shown grayed out after file size (e.g., "10.5 KB  2h ago")
  - Folders also show modified time (e.g., "3d ago")
  - Relative time format: "just now", "5m ago", "2h ago", "3d ago", "2w ago", "3mo ago", "1y ago"
  - Tooltip shows full details on hover:
    - Path (with code formatting)
    - Size
    - Modified time (full local date/time)
    - Accessed time (full local date/time)
    - Owner and Group (e.g., "root:wheel")
    - Permissions (e.g., "rwxr-xr-x")
  - Uses local time (user's timezone) for all displays
  - `IRemoteFile` interface extended with: `accessTime`, `owner`, `group`, `permissions`
  - Owner/group parsed from SFTP `longname` field (no extra server request)
  - Permissions formatted from Unix mode bits
  - New helper functions: `formatRelativeTime()`, `formatDateTime()`
  - **LITE compliant**: No additional server requests - all data already in SFTP response
- **Auto-dismiss notifications**: Status bar messages instead of persistent popups
  - Download complete, cancelled, and other non-error notifications auto-dismiss after 5s
  - Prevents screen clutter when opening multiple large files
  - Error messages remain persistent (require user attention)
  - Uses `vscode.window.setStatusBarMessage()` with timeout
  - **LITE compliant**: Minimal UI intrusion
- **Instant tab on file click**: Tab opens immediately before download completes
  - File tab appears instantly when user clicks on a file in the tree
  - Shows placeholder content: "// Loading filename...\n// Size: X KB\n// Please wait..."
  - Download happens in background with status bar indicator
  - Placeholder replaced with real content using `WorkspaceEdit` when download completes
  - If download fails, shows error message in the tab
  - **LITE compliant**: Instant visual feedback, no extra server requests
- **UX Enhancements**: Reduced notification clutter and improved feedback
  - All routine success messages now auto-dismiss via status bar (3-5s timeout)
  - Connect, disconnect, add/edit/remove host, credential operations, etc.
  - File operations (download, upload, delete, create folder) use status bar
  - Error messages remain persistent (require user attention)
  - Actionable error suggestions for connection failures:
    - ECONNREFUSED/ETIMEDOUT: "Check if the server is running and port is correct"
    - Authentication failures: "Verify your username and password/key"
    - ENOTFOUND: "Check the hostname - may be misspelled or unreachable"
  - **Keyboard shortcuts** added for common operations:
    - `Ctrl+Shift+C` (Mac: `Cmd+Shift+C`): Connect to host (in hosts view)
    - `Ctrl+Shift+T` (Mac: `Cmd+Shift+T`): Open terminal
    - `Ctrl+Shift+R` (Mac: `Cmd+Shift+R`): Refresh files
    - `Ctrl+Shift+G` (Mac: `Cmd+Shift+G`): Go to path
    - `Ctrl+Shift+F` (Mac: `Cmd+Shift+F`): Filter files
    - `Ctrl+Shift+S` (Mac: `Cmd+Shift+S`): Search in folder
  - **LITE compliant**: Minimal UI intrusion, non-blocking feedback

### 2026-01-21
- **Search results improvements**:
  - Default sort by name (A-Z), with options for path or match count
  - Click "Sort: Name" header to cycle through sort options
  - Rich tooltips on hover: file path, server, match count, line numbers
  - "Reveal in File Tree" button for search results
  - Files from search can be edited and saved normally
- **Port forward label clarity**: Shows actual server name instead of confusing "localhost ‚Üí localhost"
  - Format: `server.example.com:8082 <-> localhost:8082`
  - Bidirectional arrow icon to indicate tunnel
- **Search progress indicator**: Shows notification with cancel button during search
- **Cancel download on tab close**: Closing a tab cancels any in-progress download
- **Reveal in Tree button**: Only shows when active file is a remote SSH file
- **Tree state preservation**: Collapse/expand state preserved when navigating
  - All tree items now have unique IDs for VS Code to track
- **High-priority content update**: Click on stale placeholder triggers refresh with progress
  - Detects if tab has "// Loading..." or "// Failed to download" placeholder
  - Shows progress notification while updating content
  - Tracks active downloads to prevent duplicate requests
  - **LITE compliant**: User-triggered, shows clear progress

### 2026-01-22
- **SSH command logging**: All SSH commands logged to Output window
  - Commands logged with format: `[timestamp] [SSH hostname] $ command`
  - Long commands truncated to 200 chars
  - Visible in Output ‚Üí SSH Lite panel
- **Command logging with results**: Extension commands logged with success/failure
  - `logCommand()` and `logResult()` functions for tracking command execution
  - Format: `[CMD] connect: user@host:22` and `[‚úì] connect: Connected to Server`
  - Covers: connect, disconnect, addHost, goToPath, openFile, download, upload, delete, filter, search, terminal, port forward
- **Progressive download UX improvements**:
  - Scroll position preserved when download completes (no more jumping to line 1)
  - If user closes preview tab during download, file won't auto-open when done
  - Download cancellation improved to handle all URI schemes (ssh-lite-preview, file)
  - Status bar shows: `$(x) Download cancelled: filename` when tab closed during download
- **Unit tests added**: Jest testing framework with 69+ tests
  - Tests for helpers (expandPath, validatePort, formatFileSize, formatRelativeTime)
  - Tests for CredentialService (add, get, delete, session credentials)
  - Tests for FileTreeProvider filter matching (plain text, glob patterns)
  - Run with `npm test`, watch with `npm run test:watch`, coverage with `npm run test:coverage`
- **Monitor Server now in Remote Files view**: Added monitor icon to connection items in file explorer
- **LITE-compliant real-time monitoring options**:
  - **Live Monitor Panel** (Recommended): Webview dashboard with manual refresh button
    - Shows load average, memory, swap, network connections, disk usage, top processes
    - User clicks "Refresh" to update (no automatic polling)
    - "Live Terminal" button to open htop for continuous monitoring
    - **LITE compliant**: User-triggered refreshes only
  - **Live Terminal (htop)**: Opens SSH terminal running htop/top
    - Fallback chain: htop ‚Üí top ‚Üí shell-based monitoring script
    - Shell fallback refreshes every 2s for minimal systems without htop/top
    - User closes terminal to stop monitoring
    - **LITE compliant**: User triggers, user controls, user closes
  - Original options remain: Quick Status, Diagnose Slowness, Watch (5s), List Services, Recent Logs, Network Info, Check Service
- **Orphaned SSH file handling**: When VS Code reopens with SSH files from a previous session
  - Files remain open as read-only (can view but not edit without reconnection)
  - "Reconnect to Server" button appears in editor title bar and right-click menu
  - Click reconnect ‚Üí prompts for remote path ‚Üí connects to server ‚Üí enables editing
  - After reconnect, file is revealed in the tree and auto-upload on save is enabled
  - **LITE compliant**: No auto-reconnect, user explicitly triggers reconnection
- **Search improvements**:
  - Fixed search not finding text with special characters (e.g., `audio/ogg; codecs=opus`)
  - Search now uses `-F` (fixed string) mode by default for literal text matching
  - Enable ".*" (regex) toggle to use regular expression matching
  - Search panel UI improved: max-width container, collapsible include/exclude filters
  - Pattern inputs collapsed by default to save space
- **Live Terminal monitor fix**: Shell script syntax fixed for single-line execution
  - Fallback script now properly uses semicolons for single-line bash execution
- **Priority Queue for Preloading**: New PriorityQueueService for smart resource allocation
  - Five priority levels: CRITICAL (0), HIGH (1), MEDIUM (2), LOW (3), IDLE (4)
  - Lower number = higher priority, more connection slots allocated
  - **CRITICAL (0)**: Always executes immediately - never waits for a slot
  - **HIGH (1)**: Gets slot when ‚â•1 available (parent folder preload)
  - **MEDIUM (2)**: Gets slot when ‚â•2 available (frequent folders)
  - **LOW (3)**: Gets slot when ‚â•3 available (subdirectory preload)
  - **IDLE (4)**: Gets slot when ‚â•4 available (file preloading)
  - User actions (search, open file, navigate) bypass queue entirely - execute immediately
  - Preload tasks use queue with appropriate priority
  - `sshLite.maxPreloadingConcurrency` controls total available slots (default: 5)
  - **LITE compliant**: User actions never blocked, preloading is background work
- **Reconnect to Server improvements**:
  - Remote file path now persisted to disk (`.sshLite-metadata.json` in temp dir)
  - No more manual path entry - reconnect automatically uses stored remote path
  - Fallback to manual input only if metadata not found (old files)
  - Added "Reconnect to Server" option to tab context menu (right-click on tab header)
  - Works in: editor title bar, editor context menu, tab context menu
  - **LITE compliant**: User explicitly triggers reconnection, no auto-connect
- **Search trigger change**: Search now only triggers on Enter key or search icon click
  - Removed 300ms debounce on input - search text can be typed freely
  - Include/exclude pattern inputs also require Enter to trigger search
  - Toggle buttons (case sensitive, regex) still trigger immediate search
  - **LITE compliant**: Reduces server requests from accidental keystrokes
- **Live update file indicator**: Files being watched for real-time updates are highlighted
  - Eye icon with green color shows in file tree for watched files
  - Description shows `$(eye)` indicator next to file size
  - Tooltip shows "Live Updates: Active" status
  - FileService exposes `onWatchedFileChanged` event for tree updates
  - **LITE compliant**: Visual indicator only, no additional server requests
- **Loading spinner for file refresh**: Files being loaded/refreshed from server show spinner
  - Spinning sync icon replaces file icon during load
  - Description shows `$(sync~spin)` indicator
  - Tooltip shows "Loading from server..." status
  - FileService exposes `onFileLoadingChanged` event for tree updates
  - **LITE compliant**: Visual indicator only, no additional server requests
- **Search panel layout improvement**: Results section now spans full width
  - Only the controls section (search input, filters, scopes) constrained to 600px max
  - Results area fills entire panel width for better readability
- **Live-update highlight timeout**: Watched file highlight clears when connection lost
  - Heartbeat timer checks connection health every 3 seconds
  - For native watch: pings server if no activity for 10 seconds
  - For polling: activity updated on each successful poll
  - Highlight disappears automatically if connection drops
  - **LITE compliant**: Small stat ping only when truly needed (no activity)
- **Reconnect file reveal fix**: After reconnecting an orphaned file, tree navigates automatically
  - `revealFile()` now automatically navigates to parent folder instead of prompting user
  - Tree view reveals and highlights the file with focus after reconnection
  - No more "Navigate to File" dialog - navigation happens automatically
  - **LITE compliant**: Better UX with automatic navigation
- **Auto-reconnect on connection loss**: When VPN/network drops, SSH connections auto-recover
  - Connection loss detected via SSH close event
  - Auto-reconnect attempts every 3 seconds until successful
  - Tree view preserved during reconnection (cached data shown grayed out)
  - New `ReconnectingConnectionTreeItem` shows spinning icon with attempt count
  - Status bar shows reconnection progress
  - Manual disconnect (via UI) does NOT trigger auto-reconnect
  - New ConnectionState.Reconnecting enum value
  - `ConnectionManager.onReconnecting` event for UI updates
  - Credential preserved for seamless reconnection
  - **LITE compliant**: User initiated the original connection, auto-reconnect preserves intent
- **Fix tree item description icons**: Removed literal `$(sync~spin)` and `$(eye)` text from descriptions
  - VS Code tree item descriptions don't render codicons as icons
  - Removed these text indicators - the actual icon already shows the state
  - Description now only shows: file size and modified time
- **Eye icon shows for ALL open files in tabs**: Changed from single-file tracking to multi-file
  - Eye icon now shows for ANY file that is open in an editor tab
  - Not limited to just the active/focused file
  - Added `setupOpenFilesTracker()` to monitor tab changes
  - Added `onOpenFilesChanged` event for tree updates
  - Tabs are scanned via `vscode.window.tabGroups.all`
  - Updates on `onDidChangeTabs` and `onDidCloseTextDocument` events
  - **LITE compliant**: Only visual indicator, no additional server requests

### 2026-01-23
- **Permission denied file handling**: Better UX for inaccessible files
  - When file download fails (permission denied, etc.), tab is closed cleanly
  - No more dirty document with save confirmation dialog
  - Error message displayed via `showErrorMessage` instead
  - Placeholder file cleaned up from temp directory
  - **LITE compliant**: Clean error handling, no user confusion
- **Tree expansion state preservation**: Folders stay expanded when parent collapses
  - Added `expandedFolders` Set to track expansion state per connection
  - `trackExpand()` and `trackCollapse()` methods called from tree view events
  - `FileTreeItem` now uses `shouldBeExpanded` parameter to restore state
  - Expansion state cleared on disconnect
  - **LITE compliant**: Better UX, no additional server requests
- **Search scope from file search icon**: Clicking search on file adds parent folder
  - `searchInScope` command now uses parent folder for files, folder itself for directories
  - More intuitive behavior - searching "here" means the containing folder
- **Cancel search functionality**: Ability to stop ongoing search
  - Added `AbortController` to `SearchPanel` for cancellation
  - Added `cancelSearch` command and handler
  - Cancel button appears in search panel during search (replaces search button)
  - `searchCancelled` message type for webview notification
  - Cancelled searches stop cleanly without showing partial results
  - **LITE compliant**: Reduces server load by stopping unnecessary searches
- **Activity Panel**: View all running commands/operations in a dedicated panel
  - New "Activity" view in sidebar showing all ongoing operations
  - Grouped by server (primary) with option to toggle to group by type
  - Tracked activity types: search, download, upload, directory-load, file-refresh, preload, monitor, terminal, connect, disconnect
  - Each activity shows: description, server name, progress, duration, status
  - Activity statuses: running (with spinner), completed (green check), cancelled (yellow), failed (red)
  - Cancellable activities show cancel button inline
  - Commands: `cancelActivity`, `cancelAllActivities`, `cancelServerActivities`, `clearActivities`, `toggleActivityGrouping`
  - New files: `ActivityService.ts` (singleton for tracking), `ActivityTreeProvider.ts` (tree view)
  - Integrated with: SearchPanel (search operations), FileService (download/upload)
  - Completed/failed/cancelled activities auto-remove after 3-5 seconds
  - **LITE compliant**: Visual monitoring only, no additional server requests
- **Search reveal in tree**: Navigate from search results to file in explorer
  - Added üìç reveal button to file headers in both list and tree view
  - Clicking reveals file in Remote Files explorer and highlights it
  - Implemented `sshLite.revealSearchResultInTree` command
- **Code quality fixes**: Fixed several bugs and inconsistencies
  - Fixed terminal null check in `searchInFile` command (could crash if terminal creation failed)
  - Fixed inconsistent `require('path')` usage - now uses imported `path` module
  - **LITE compliant**: Improved stability and code consistency
- **UI/UX consistency fixes**: Standardized feedback patterns across all handlers
  - Navigation feedback: `goToParent`, `goToHome`, `goToRoot` now show status bar confirmation
  - "Already at root" now uses `setStatusBarMessage` instead of modal dialog
  - Delete with backup now uses `setStatusBarMessage` (was modal dialog blocking workflow)
  - Restore backup now uses `setStatusBarMessage` (was modal dialog)
  - All "no backups found" messages now use `setStatusBarMessage` (was modal dialogs)
  - "SSH config hosts must be edited" now uses `setStatusBarMessage` (was modal dialog)
  - Standardized timeout pattern: 2000ms (quick), 3000ms (success), 5000ms (info/error)
  - **LITE compliant**: Non-blocking feedback, minimal UI intrusion
- **Fixed auto-reconnect on manual disconnect**: Critical race condition bug
  - Bug: Clicking disconnect icon would trigger auto-reconnect due to async race condition
  - Root cause: SSH2 'close' event fires asynchronously AFTER `disconnect()` returns
  - Old code deleted `_disconnectedConnections` entry before the close event fired
  - Close event handler saw `undefined` for `isManualDisconnect` ‚Üí triggered reconnect
  - Fix: Let the state handler clean up maps when close event fires (don't delete early)
  - Affected both `disconnect()` and `disconnectAll()` methods in ConnectionManager
- **Fixed search not finding text with leading dashes**: Critical grep option parsing bug
  - Bug: Searching for text like "-lfsms-" returned no results
  - Root cause: Grep interprets leading dash as command option, not search pattern
  - Fix: Added `--` (end of options) before the pattern in grep command
  - File: `src/connection/SSHConnection.ts` line 1243
- **Raw command logging improvements**: Full commands visible in Output window
  - Removed 200 char truncation limit from `logSSHCommand()` - shows FULL commands
  - Added `logSFTPOperation()` for tracking SFTP operations (LIST, READ, WRITE)
  - All operations now visible in "SSH Lite Commands" output channel
  - File: `src/connection/SSHConnection.ts`
- **Resizable search panel**: Controls section now horizontally resizable (width)
  - Layout changed from vertical (column) to horizontal (row)
  - Controls section on left, results section on right
  - Vertical resizer bar between controls and results (drag left/right)
  - Drag to resize controls width (min 200px, max 80% viewport width)
  - Default width: 350px
  - Visual feedback on hover and drag (blue highlight)
  - File: `src/webviews/SearchPanel.ts`
- **Activity panel completeness**: More operations tracked
  - Deep filter search (`searchServerForFilter`) now tracked in Activity panel
  - Filename filter search (`setFilenameFilter`) now tracked in Activity panel
  - File: `src/providers/FileTreeProvider.ts`
- **Search result click optimization**: No file reload for already-open files
  - Changed check from `visibleTextEditors` to `textDocuments` (includes hidden tabs)
  - If file is already open in any tab (visible or hidden), just focuses without reloading
  - File: `src/extension.ts` line 1081
- **Tree view auto-expand on first switch**: Directories expand when switching to tree view
  - Added `treeViewFirstExpand` flag to track first switch
  - Added `expandAllTreeNodes()` function to collect directory node keys only
  - When switching from list to tree view first time, all directories expand to show files
  - Files stay collapsed - their matches don't show until user clicks to expand
  - File: `src/webviews/SearchPanel.ts`
- **File search scope support**: Search icon on files adds file to SEARCH IN section
  - Extended `SearchScope` interface with `isFile` property
  - Files added directly to search scope (not converted to parent directory)
  - Search scope list shows üìÑ icon for files, üìÅ icon for folders
  - grep can search within single file paths directly
  - Files: `src/webviews/SearchPanel.ts`, `src/extension.ts`
- **Expand All / Collapse All toggle button**: Single toggle button in all tree views
  - Shows "Expand All" when tree is collapsed, "Collapse All" when any item is expanded
  - Context variables track expansion state: `sshLite.{view}.expanded`
  - Tree views track onDidExpandElement to update state automatically
  - Inline navigation button (navigation@99) for easy access
  - Works on: SSH Hosts, Remote Files, Activity, Port Forwards
  - Files: `package.json`, `src/extension.ts`
- **Parent folder item visual highlight**: "Go to parent folder" now more prominent
  - Changed icon from `folder-opened` to `arrow-up` with yellow highlight color
  - Uses `charts.yellow` ThemeColor for high visibility (priority #1 action)
  - Added rich tooltip with markdown showing target path
  - File: `src/providers/FileTreeProvider.ts`
- **Priority queue adjustments**: Optimized background task priorities
  - Subdirectory preload (first time): Changed from LOW to HIGH priority for fast initial loads
  - Subdirectory preload (frequent): Remains at MEDIUM priority
  - Tail-follow preview updates: Changed from LOW to MEDIUM priority
  - Files: `src/providers/FileTreeProvider.ts`, `src/providers/ProgressiveFileContentProvider.ts`
- **Multi-server tree state preservation**: Tree expansion state now persists across all connections
  - Root cause: Full tree refreshes (`fire()` with no args) caused VS Code to lose expansion state
  - Fix: Replaced full refreshes with targeted per-connection refreshes using stored `ConnectionTreeItem` refs
  - `connectionTreeItemRefs` Map stores last-created tree item references per connection
  - `refreshConnection(connectionId)` method refreshes only one connection's subtree
  - `setCurrentPath` now uses targeted refresh (was full refresh)
  - `refreshFolder` now uses targeted refresh (was full refresh)
  - `revealFile` now uses targeted refresh (was full refresh)
  - Auto-refresh timer now refreshes each connection individually (was single full refresh)
  - Removed full tree refresh from `onOpenFilesChanged` (tab switch no longer resets tree)
  - Eye icon updates silently (shows on next natural render, like loading spinners)
  - File: `src/providers/FileTreeProvider.ts`
- **Filename filter fix**: Filter now provides clear visual feedback
  - Bug: Filtered folder (basePath) was not added to `highlightedPaths` ‚Äî no visual change on filter
  - Fix: basePath now added to highlightedPaths, filtered folder shows blue `filter-filled` icon with `[filter: pattern]`
  - Added `isFiltered`/`filterPattern` params to `FileTreeItem` constructor
  - `contextValue: 'folder.filtered'` on the filtered folder (distinct from regular `folder`)
  - Filtered folder clears `resourceUri` to prevent file icon theme overriding custom icon
  - Inline "clear filter" (X) icon on filtered folder for quick removal
  - Context menu "Clear Filename Filter" on filtered folder
  - Updated all folder menu `when` clauses: `viewItem =~ /^folder/` (matches both `folder` and `folder.filtered`)
  - `filterFileNames` only on `viewItem == folder` (not on already-filtered folders)
  - Added `await` to `setFilenameFilter` call in command handler
  - Added `shouldHighlightByFilter()` fallback: local filename matching when `find` paths don't match tree paths (symlinks, realpath)
  - Files: `src/providers/FileTreeProvider.ts`, `src/extension.ts`, `package.json`

<!--
Copyright 2026 SSH Lite Contributors

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->

# SSH Lite - Claude Code Workflow

This file documents how to regenerate the SSH Lite VS Code extension using Claude Code.

---

## IMPORTANT: Claude Code Rules

**YOU MUST FOLLOW THESE RULES AT EVERY PROMPT:**

1. **READ this workflow file at the START of every prompt** - Before doing anything else
2. **UPDATE this workflow file** if there are any flow/feature/implementation changes
3. **NEVER forget these rules** - They are critical for maintaining project consistency
4. **DEBATE the user** if they request a feature that violates:
   - **LITE principles** (uses server resources automatically, polls, preloads without user action)
   - **Simplicity principles** (overly complex, too many options, confusing UX)
   - Push back respectfully and propose LITE/simple alternatives before implementing

---

## Project Overview

**SSH Lite** is a lightweight VS Code extension for SSH connections that works WITHOUT installing a VS Code server on remote machines (unlike Remote-SSH).

### Core Principles
1. **Simple and easy to use** - This is the MOST important principle
2. **No server installation** - Works via pure SSH/SFTP
3. **Auto-save credentials** - No complex credential management
4. **Lightweight** - Minimal footprint

---

## ⚠️ LITE PRINCIPLES (CRITICAL - READ BEFORE IMPLEMENTING)

**SSH Lite must be LITE.** This means minimizing server resource usage and SSH connections at all costs.

### Rules for ALL Features:

1. **NO automatic server commands** - Never run shell commands (grep, find, ls, etc.) automatically
   - ❌ BAD: Running `find` on every filter keystroke
   - ✅ GOOD: User clicks "Search" button to trigger server search

2. **NO polling/background refresh by default** - All auto-refresh features must be:
   - Disabled by default (interval = 0)
   - User must explicitly enable in settings
   - Use reasonable minimum intervals (>10s)

3. **Cache aggressively, fetch lazily** - Prefer local cache over server requests
   - ❌ BAD: Preloading 5 subdirectories automatically
   - ✅ GOOD: Load only what user explicitly expands

4. **Single connection per host** - Reuse SSH connections, never open multiple
   - Terminal, SFTP, and commands share the same connection

5. **Debounce user actions** - Rapid user input should not spam the server
   - Minimum 300ms debounce for any server-triggering action

6. **Opt-in expensive features** - Features that use server resources should:
   - Require explicit user action (button click, command)
   - Show clear indication of server activity
   - Be configurable to disable

### When Reviewing New Features, Ask:

1. Does this run server commands automatically? → Make it user-triggered
2. Does this poll the server? → Make it opt-in with default OFF
3. Does this preload data? → Make it lazy-load on demand
4. Does this open new connections? → Reuse existing connection

### Current Violations (FIXED):

- [x] Deep filter search runs `find` automatically → Fixed: Now user-triggered via "Search Server for Filter" button
- [x] Subdirectory preloading → Fixed: Disabled by default, controlled by `sshLite.enablePreloading` setting
- [x] Frequent file preloading → Fixed: Disabled by default, controlled by `sshLite.enablePreloading` setting

---

## Features to Implement

### 1. SSH Connection Management
- Parse `~/.ssh/config` for hosts
- Allow manual host addition (saved to VS Code settings)
- Support password, private key, and SSH agent authentication
- Auto-save credentials using VS Code SecretStorage
- Keyboard-interactive authentication support
- Connection timeout (configurable, default 30s)
- Keepalive interval (configurable)

### 2. File Browser (Tree View)
- Show connected servers in sidebar
- Browse remote files/folders via SFTP
- Navigate to any path (Go to Path, Go to Parent, Go to Home, Go to Root)
- Show current path in connection description
- Parent folder (..) navigation
- Auto-refresh tree (configurable interval)

### 3. File Operations
- Open remote files for editing
- Auto-upload on save
- Download files/folders
- Upload files
- Delete files/folders
- Create folders
- Large file handling (>100MB):
  - Background download with progress
  - Preview first lines
  - Download to disk
  - View with head/tail

### 4. File Auto-Refresh
- Global timer for all opened files
- Prioritize focused file (refresh first)
- Refresh non-focused files after focused
- Smart conflict handling:
  - Auto-refresh if no local changes
  - Prompt if local unsaved changes exist

### 5. Terminal
- Open SSH terminal for any connection
- Multiple terminals per connection
- Reuse existing connection (no re-login)

### 6. Port Forwarding
- Forward local ports to remote
- List active forwards
- Stop forwards

### 7. Server Monitoring
- Quick status (CPU, memory, disk, load)
- Diagnose slowness (top processes, memory hogs)
- Watch status (live updates)
- Check specific service
- List services
- Recent logs
- Network diagnostics

### 8. Audit Trail
- Log all file operations (download, upload, edit, delete)
- Track diffs for edits
- Export audit log
- Clear audit log

## Project Structure

```
SSHLite/
├── src/
│   ├── extension.ts              # Main entry, command registration
│   ├── types.ts                  # Interfaces and types
│   ├── connection/
│   │   ├── ConnectionManager.ts  # Manage multiple connections
│   │   └── SSHConnection.ts      # SSH/SFTP operations
│   ├── services/
│   │   ├── HostService.ts        # Parse SSH config, manage hosts
│   │   ├── FileService.ts        # File operations, auto-sync
│   │   ├── TerminalService.ts    # SSH terminals
│   │   ├── PortForwardService.ts # Port forwarding
│   │   ├── CredentialService.ts  # Simple credential storage
│   │   ├── AuditService.ts       # Audit trail logging
│   │   └── ServerMonitorService.ts # Server diagnostics
│   ├── providers/
│   │   ├── HostTreeProvider.ts   # SSH hosts tree view
│   │   ├── FileTreeProvider.ts   # Remote files tree view
│   │   └── PortForwardTreeProvider.ts # Port forwards tree
│   └── utils/
│       └── helpers.ts            # Utility functions
├── package.json                  # Extension manifest
├── tsconfig.json                 # TypeScript config
├── .vscodeignore                 # Exclude from package
├── .vscode/
│   ├── launch.json               # F5 debugging
│   └── tasks.json                # Build tasks
└── README.md                     # Documentation with SEO
```

## Key Implementation Details

### CredentialService (Multiple Credentials per Host)
```typescript
// Support multiple named credentials per host with pinned folders
interface PinnedFolder {
  id: string;
  name: string;
  remotePath: string;
}

interface SavedCredential {
  id: string;
  label: string;
  type: 'password' | 'privateKey';
  privateKeyPath?: string;
  pinnedFolders?: PinnedFolder[];
}

// API
await creds.listCredentials(hostId)  // List all credentials for a host
await creds.addCredential(hostId, label, type, value, keyPath?)
await creds.getCredentialSecret(hostId, credentialId)
await creds.deleteCredential(hostId, credentialId)
await creds.deleteAll(hostId)

// Pinned folders API
await creds.addPinnedFolder(hostId, credentialId, name, remotePath)
await creds.deletePinnedFolder(hostId, credentialId, folderId)
await creds.renamePinnedFolder(hostId, credentialId, folderId, newName)
await creds.getPinnedFolders(hostId, credentialId)

// Legacy API for backward compatibility
await creds.get(hostId, 'password')
await creds.save(hostId, 'password', value)
await creds.getOrPrompt(hostId, 'password', 'Enter password')
```

### HostTreeProvider (Expandable Hosts)
- Hosts are expandable (collapsed by default) to show credentials
- Connected hosts are NOT expandable (already connected)
- Child items: CredentialTreeItem (click to connect), AddCredentialTreeItem (+ to add)
- Click on credential to connect with that specific credential
- Credentials with pinned folders are expandable to show PinnedFolderTreeItem children
- Click on pinned folder to connect and navigate to that folder

### SSHConnection Authentication Flow
- If specific credential provided: use only that credential
- Otherwise (legacy): Try multiple auth methods
  1. Try configured private key
  2. Try default keys (~/.ssh/id_rsa, id_ed25519, id_ecdsa)
  3. Try SSH agent
  4. Fall back to password (always included for keyboard-interactive)
  5. Handle keyboard-interactive auth
  6. On auth failure, clear saved credentials

### FileService Auto-Refresh
```typescript
// Single global timer, not per-file
private globalRefreshTimer
private isRefreshing = false

async refreshOpenedFiles() {
  // 1. Refresh focused file first
  // 2. Then refresh other non-focused files
}
```

### FileTreeProvider Navigation
- Track current path per connection: `Map<connectionId, path>`
- Show (..) parent folder item at top
- Commands: goToPath, goToParent, goToHome, goToRoot

## Configuration Options

```json
{
  "sshLite.connectionTimeout": 30000,
  "sshLite.keepaliveInterval": 30000,
  "sshLite.defaultRemotePath": "~",
  "sshLite.autoUploadOnSave": true,
  "sshLite.uploadDebounceMs": 500,
  "sshLite.treeRefreshIntervalSeconds": 10,
  "sshLite.fileRefreshIntervalSeconds": 3,
  "sshLite.smartRefreshThreshold": 512000,
  "sshLite.largeFileSizeThreshold": 104857600,
  "sshLite.auditLogPath": "",
  "sshLite.tempFileRetentionHours": 504,
  "sshLite.credentialIndex": {}
}
```

## Dependencies

```json
{
  "dependencies": {
    "ssh2": "^1.16.0",
    "ssh-config": "^5.0.0"
  }
}
```

## Commands to Register

- sshLite.connect
- sshLite.disconnect
- sshLite.addHost
- sshLite.editHost
- sshLite.removeHost
- sshLite.refreshHosts
- sshLite.goToPath
- sshLite.goToParent
- sshLite.goToHome
- sshLite.goToRoot
- sshLite.openFile
- sshLite.downloadFile
- sshLite.uploadFile
- sshLite.deleteRemote
- sshLite.createFolder
- sshLite.refreshFiles
- sshLite.openTerminal
- sshLite.forwardPort
- sshLite.stopForward
- sshLite.showAuditLog
- sshLite.exportAuditLog
- sshLite.clearAuditLog
- sshLite.monitor
- sshLite.quickStatus
- sshLite.diagnoseSlowness
- sshLite.clearCredentials
- sshLite.addCredential
- sshLite.connectWithCredential
- sshLite.deleteCredential
- sshLite.clearAllTempFiles
- sshLite.clearTempFilesForConnection
- sshLite.openTempFolder
- sshLite.pinFolder
- sshLite.connectToPinnedFolder
- sshLite.deletePinnedFolder
- sshLite.renamePinnedFolder
- sshLite.revertFile
- sshLite.showFileBackups
- sshLite.showServerBackups
- sshLite.clearServerBackups
- sshLite.showBackupLogs
- sshLite.openServerBackupFolder
- sshLite.openTerminalHere
- sshLite.filterFiles
- sshLite.clearFilter
- sshLite.searchServerForFilter
- sshLite.searchInFolder
- sshLite.openSearchResult
- sshLite.clearSearchResults

## Regeneration Steps

1. Create new VS Code extension project:
   ```bash
   npm init -y
   npm install ssh2 ssh-config
   npm install -D typescript @types/node @types/vscode @types/ssh2
   ```

2. Copy the project structure above

3. Ask Claude Code to implement each service following the patterns described

4. Key reminders for Claude:
   - Keep CredentialService SIMPLE (no profiles, auto-save by default)
   - File refresh: focused file first, then others
   - Navigation: track current path per connection
   - Always handle keyboard-interactive auth

## Testing

Press F5 in VS Code to launch extension development host.

## Building

```bash
npm run compile    # Compile TypeScript
npm run watch      # Watch mode
npm run clean      # Clean build artifacts
```

## Packaging

```bash
npx vsce package   # Creates .vsix file
```

---

## Recent Changes Log

Track all significant changes here:

### 2026-01-19
- Added config change listener to FileService - timer restarts when `fileRefreshIntervalSeconds` changes
- File refresh: focused file gets priority, non-focused files refresh after
- Added navigation commands: goToPath, goToParent, goToHome, goToRoot
- Added (..) parent folder item in file tree
- Track current path per connection in FileTreeProvider
- Fixed authentication to always include password for keyboard-interactive fallback
- Connection timeout increased to 30s default
- Clear saved credentials on auth failure
- **Optimized file opening**: Editor opens immediately with "Loading..." placeholder, content loads in background
- **Fixed: Clicking connected server no longer disconnects** - Click only connects disconnected hosts; disconnect via menu/icon
- **Credential management redesign**: Hosts now expandable to show saved credentials
  - Click on host expands to show credentials + "Add Credential..." item
  - Click on credential to connect with that specific auth method
  - Support for password and private key credentials with labels
  - Delete individual credentials via context menu
- **Temp file auto-cleanup**: Configurable `tempFileRetentionHours` (default 504h = 21 days)
  - Auto-cleanup runs hourly
  - Commands: clearAllTempFiles, clearTempFilesForConnection, openTempFolder
  - Open temp folder in file explorer via menu or command palette
- **Pinned folders**: Save frequently used folders to credentials for quick access
  - Right-click folder in file tree → "Pin Folder to Credential"
  - Pinned folders appear under credentials in host tree
  - Click pinned folder to connect and navigate directly to that path
  - Right-click pinned folder to rename or delete
- **Connected hosts now expandable**: Can view credentials and pinned folders even when connected
  - Credentials show "(connected)" tooltip when host is connected
  - Pinned folders navigate directly when host is already connected
- **Loading indicators**: Show spinning icons during folder/file refresh
  - Connection shows loading spinner while listing directory
  - Status bar shows refresh indicator for focused file
- **Safe file loading**: File content loading doesn't trigger upload
  - Uses `skipNextSave` set to prevent upload when clearing dirty state after load
  - Double safety: mapping only added after save completes
- **Fixed file save conflict**: Auto-refresh now updates editor before disk
  - Updates editor content first, then saves (avoids VS Code conflict detection)
  - Uses `skipNextSave` to prevent upload when syncing FROM remote
- **Parallel loading and preloading**: Directory tree loads faster
  - Directory cache (30s TTL) avoids redundant API calls
  - Deduplication prevents multiple concurrent loads for same path
  - Preloads subdirectories in background (first 5 dirs)
  - Preloads all connection root directories in parallel
  - Cache-hit loads show instantly without loading indicator
- **File upload confirmation and backup system**: Safer file editing
  - Optional confirmation dialog before upload (`sshLite.confirmUpload` setting)
  - "View Changes" option shows diff before upload
  - Automatic backup of old content before each upload
  - Backup history stored in memory (max 10 per file) and on disk
  - "Revert" button in upload notification
  - `sshLite.revertFile` and `sshLite.showFileBackups` commands
  - Right-click file → "Show File Backup History"
- **Server-side backup system**: Original files preserved on remote server
  - Creates backup in `/tmp/.ssh-lite-backups/` when opening file for edit
  - Backup filename includes timestamp: `filename_2026-01-19T12-30-45-123Z.ext`
  - `sshLite.showServerBackups` - View and restore from server backups
  - `sshLite.clearServerBackups` - Clear all backups for a connection
  - Show diff between current file and server backup
  - Restore creates backup of current version first (safety)
  - Auto-cleanup based on `tempFileRetentionHours` setting
- **Combined backup logs**: View all backups (local + server) in one place
  - `sshLite.showBackupLogs` - Right-click file to see combined backup history
  - Shows both local (memory/disk) and server-side backups sorted by date
  - View diff or restore from any backup
- **Open Server Backup Folder**: Quick access to remote backup directory
  - `sshLite.openServerBackupFolder` - Right-click connected host
  - Lists all backups in output panel
  - Option to open terminal at backup folder or clear all backups
- **Open Terminal Here**: Open terminal at file/folder location
  - `sshLite.openTerminalHere` - Right-click on file or folder in file tree
  - Opens SSH terminal and navigates to that directory
  - For files, navigates to parent directory
- **Smart preloading (opt-in)**: Preload folders and files for instant navigation
  - **LITE**: Disabled by default (`sshLite.enablePreloading: false`)
  - When enabled: preloads home, parent, frequent folders/files
  - File history tracked in `FolderHistoryService` alongside folder history
- **Fixed double slash in paths**: Terminal "Open Here" no longer shows `//path`
  - Fixed `mapFileList` in `SSHConnection.ts` to handle root path specially
- **Fixed file preview mode**: Double-click files now open in edit mode (non-italic tab)
  - Added `{ preview: false }` to all `showTextDocument` calls
- **Fixed tree indentation on scroll**: Files no longer appear at wrong indent level
  - `getParent` method now properly returns parent `FileTreeItem` for nested directories
  - VS Code's tree virtualization can correctly reconstruct hierarchy when scrolling
- **File filter (LITE mode)**: Filter files in tree view
  - `sshLite.filterFiles` - Open filter input (supports glob: *.ts, config*, etc.)
  - `sshLite.clearFilter` - Clear the current filter
  - `sshLite.searchServerForFilter` - **User-triggered** server search for current filter
  - Filter icon in file explorer title bar
  - **LITE**: Only filters cached/loaded files by default (no server commands)
  - **Optional**: Click "Search Server" button to run `find` on server
  - Directories always shown when filtering (to allow navigation)
  - Supports `*` (any chars) and `?` (single char) wildcards
  - Server search results limited to 200 files per connection
- **Remote file search**: Search files on remote server using grep/find
  - `sshLite.searchInFolder` - Search in a specific folder (right-click folder or title bar icon)
  - `sshLite.openSearchResult` - Open file at search result location
  - `sshLite.clearSearchResults` - Clear search results panel
  - Content search uses `grep -rnH` for recursive text search with line numbers
  - Filename search uses `find` command for matching file paths
  - Case-insensitive by default, configurable via search options
  - File pattern filter (e.g., *.ts, *.py) to limit search scope
  - Max results limit (default 500) to prevent overwhelming output
  - Results grouped by file in tree view with expandable matches
  - Click result to open file at exact line number
- **Session-based directory caching**: Cache persists until disconnect for faster navigation
  - Removed 30-second TTL from directory cache - cache now persists for entire session
  - Cache cleared automatically on disconnect (manual or unexpected)
  - Deep filter results also cleared on disconnect
  - Preloading continues to load first 5 subdirectories on folder expand
- **Loading spinner on tree items**: Shows spinning icon when loading folder contents
  - `LoadingTreeItem` class shows `$(sync~spin)` spinning icon
  - Appears as child of folder/connection being expanded while loading
  - Replaced await-based loading with non-blocking pattern for immediate visual feedback
  - Tree item refreshes automatically when loading completes

### 2026-01-20
- **Smart tail-based file refresh**: Reduces bandwidth for large growing files
  - Files above threshold (default 500KB) that grow use incremental tail fetch
  - Only new bytes are downloaded instead of entire file (97%+ bandwidth reduction)
  - Falls back to full download if file shrinks or tail command fails
  - Shows status: `$(zap) Smart refresh: file.log (+10KB, saved 5MB)`
  - `sshLite.smartRefreshThreshold` setting (default: 512000 = 500KB, set 0 to disable)
  - **LITE compliant**: Reduces server load of existing refresh feature
  - New `readFileTail()` method in SSHConnection uses `tail -c +OFFSET`
  - `FileMapping` interface extended with `lastRemoteSize` for tracking
- **Real-time file watching with inotify/fswatch**: Instant file updates like Microsoft Remote-SSH
  - Automatically watches the focused/active SSH file for changes
  - Uses `inotifywait` on Linux (instant kernel notifications)
  - Uses `fswatch` on macOS/BSD (instant file system events)
  - Falls back to polling if native tools not available
  - `ServerCapabilities` interface tracks OS and available watchers
  - `detectCapabilities()` runs on connection to detect OS and tools
  - `watchFile()`/`unwatchFile()` methods for managing watchers
  - `onFileChange` event emitter for change notifications
  - 100ms debounce for rapid changes (log files)
  - Shows status: `$(eye) Watching file.log for changes`
  - **LITE compliant**: Only watches focused file, stops when switching files
- **File/folder timestamps in tree view**: Shows last modified time for better file management
  - Modified time shown grayed out after file size (e.g., "10.5 KB  2h ago")
  - Folders also show modified time (e.g., "3d ago")
  - Relative time format: "just now", "5m ago", "2h ago", "3d ago", "2w ago", "3mo ago", "1y ago"
  - Tooltip shows full details on hover:
    - Path (with code formatting)
    - Size
    - Modified time (full local date/time)
    - Accessed time (full local date/time)
    - Owner and Group (e.g., "root:wheel")
    - Permissions (e.g., "rwxr-xr-x")
  - Uses local time (user's timezone) for all displays
  - `IRemoteFile` interface extended with: `accessTime`, `owner`, `group`, `permissions`
  - Owner/group parsed from SFTP `longname` field (no extra server request)
  - Permissions formatted from Unix mode bits
  - New helper functions: `formatRelativeTime()`, `formatDateTime()`
  - **LITE compliant**: No additional server requests - all data already in SFTP response
- **Auto-dismiss notifications**: Status bar messages instead of persistent popups
  - Download complete, cancelled, and other non-error notifications auto-dismiss after 5s
  - Prevents screen clutter when opening multiple large files
  - Error messages remain persistent (require user attention)
  - Uses `vscode.window.setStatusBarMessage()` with timeout
  - **LITE compliant**: Minimal UI intrusion
- **Instant tab on file click**: Tab opens immediately before download completes
  - File tab appears instantly when user clicks on a file in the tree
  - Shows placeholder content: "// Loading filename...\n// Size: X KB\n// Please wait..."
  - Download happens in background with status bar indicator
  - Placeholder replaced with real content using `WorkspaceEdit` when download completes
  - If download fails, shows error message in the tab
  - **LITE compliant**: Instant visual feedback, no extra server requests
- **UX Enhancements**: Reduced notification clutter and improved feedback
  - All routine success messages now auto-dismiss via status bar (3-5s timeout)
  - Connect, disconnect, add/edit/remove host, credential operations, etc.
  - File operations (download, upload, delete, create folder) use status bar
  - Error messages remain persistent (require user attention)
  - Actionable error suggestions for connection failures:
    - ECONNREFUSED/ETIMEDOUT: "Check if the server is running and port is correct"
    - Authentication failures: "Verify your username and password/key"
    - ENOTFOUND: "Check the hostname - may be misspelled or unreachable"
  - **Keyboard shortcuts** added for common operations:
    - `Ctrl+Shift+C` (Mac: `Cmd+Shift+C`): Connect to host (in hosts view)
    - `Ctrl+Shift+T` (Mac: `Cmd+Shift+T`): Open terminal
    - `Ctrl+Shift+R` (Mac: `Cmd+Shift+R`): Refresh files
    - `Ctrl+Shift+G` (Mac: `Cmd+Shift+G`): Go to path
    - `Ctrl+Shift+F` (Mac: `Cmd+Shift+F`): Filter files
    - `Ctrl+Shift+S` (Mac: `Cmd+Shift+S`): Search in folder
  - **LITE compliant**: Minimal UI intrusion, non-blocking feedback
